<!DOCTYPE html>
<html>
<head>
    <title>AnlıkGörüş - Canlı Akış</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7fa; padding-top: 60px; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background-color: #007bff; color: white; padding: 10px 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header h1 { margin: 0; font-size: 20px; }
        .header button { margin-left: 10px; }
        #cikis-yap { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .anket-olustur-buton { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #anket-akisi { display: flex; flex-direction: column; align-items: center; padding: 15px 0; }
        .anket-karti { 
            width: 95%; max-width: 550px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); margin-bottom: 20px; padding: 15px; overflow: hidden; 
            opacity: 1; 
            transition: opacity 0.5s ease; 
        }
        .oylanmis { opacity: 0.7; border: 2px solid #28a745; }
        .anket-baslik { text-align: center; color: #333; font-size: 18px; margin-bottom: 15px; }
        .secenekler-konteyner { display: flex; gap: 8px; height: 250px; }
        .secenek { flex: 1; position: relative; cursor: pointer; overflow: hidden; border-radius: 8px; transition: transform 0.2s; }
        .resim { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        .oy-gosterge { position: absolute; bottom: 0; left: 0; height: 100%; width: 0%; background: rgba(0, 123, 255, 0.4); z-index: 2; transition: width 0.5s ease-out; }
        .oy-yuzdesi { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold; color: white; text-shadow: 0 0 4px rgba(0, 0, 0, 0.6); z-index: 3; }
        .kalan-sure { text-align: center; margin-top: 15px; font-weight: bold; color: #dc3545; font-size: 14px; }
        .gonderen-bilgi { text-align: right; font-size: 12px; color: #777; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>AnlıkGörüş</h1>
        <div>
            <button class="anket-olustur-buton" onclick="window.location.href='anket_olustur.html'">Anket Oluştur</button>
            <button id="cikis-yap">Çıkış Yap</button>
        </div>
    </div>

    <div id="anket-akisi">
        <p style="text-align: center; color: #777;">Anketler Yükleniyor...</p>
    </div>
    
    <script>
        // Giriş Kontrolü ve UID Alma
        let currentUserId = null;
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                alert("Bu sayfayı görüntülemek için lütfen giriş yapın.");
                window.location.href = 'giris.html';
            } else {
                currentUserId = user.uid;
            }
        });

        document.getElementById('cikis-yap').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'giris.html';
            }).catch((error) => {
                alert("Çıkış yaparken hata oluştu.");
            });
        });

        const anketAkisi = document.getElementById('anket-akisi');
        const defaultImageURL = 'https://via.placeholder.com/300x400?text=Resim+Yok'; 
        const timerIntervals = {}; 
        
        // ------------- KART OLUŞTURMA VE GÜNCELLEME -------------
        
        function anketKartiOlustur(docId, anket) {
            const oyKullanildi = anket.oyKullananlar && anket.oyKullananlar.includes(currentUserId);
            const oylanmisClass = oyKullanildi ? 'oylanmis' : '';

            const oylarA = anket.oylar.A || 0;
            const oylarB = anket.oylar.B || 0;
            const toplamOy = oylarA + oylarB;
            const yuzdeA = toplamOy > 0 ? Math.round((oylarA / toplamOy) * 100) : 50;
            const yuzdeB = 100 - yuzdeA;
            
            // Kullanıcı oy kullandıysa veya süre bittiyse tıklama engellenir
            const tiklamaEngeli = oyKullanildi;
            const clickHandler = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'A')"`;
            const clickHandler2 = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'B')"`;

            // Kart zaten varsa HTML'i yeniden oluşturmak yerine sadece güncelle
            const existingCard = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);
            if (existingCard) {
                existingCard.querySelector('#yuzde-A-' + docId).innerHTML = `${yuzdeA}%`;
                existingCard.querySelector('#yuzde-B-' + docId).innerHTML = `${yuzdeB}%`;
                existingCard.querySelector('.A-gosterge').style.width = `${yuzdeA}%`;
                existingCard.querySelector('.B-gosterge').style.width = `${yuzdeB}%`;
                if (oyKullanildi && !existingCard.classList.contains('oylanmis')) {
                    existingCard.classList.add('oylanmis');
                    existingCard.querySelectorAll('.secenek').forEach(s => s.removeAttribute('onclick'));
                }
                return;
            }

            // Yeni Kart Oluştur
            const newCardHTML = `
                <div class="anket-karti ${oylanmisClass}" data-anket-id="${docId}">
                    <h2 class="anket-baslik">${anket.baslik}</h2>
                    
                    <div class="secenekler-konteyner">
                        
                        <div class="secenek secenek-sol" ${clickHandler}>
                            <img src="${anket.resimA || defaultImageURL}" alt="Seçenek A" class="resim">
                            <div class="oy-gosterge A-gosterge" style="width: ${yuzdeA}%;"></div>
                            <span class="oy-yuzdesi" id="yuzde-A-${docId}">${yuzdeA}%</span>
                        </div>

                        <div class="secenek secenek-sag" ${clickHandler2}>
                            <img src="${anket.resimB || defaultImageURL}" alt="Seçenek B" class="resim">
                            <div class="oy-gosterge B-gosterge" style="width: ${yuzdeB}%;"></div>
                            <span class="oy-yuzdesi" id="yuzde-B-${docId}">${yuzdeB}%</span>
                        </div>
                    </div>
                    
                    <div class="kalan-sure" id="sure-sayaci-${docId}">Kalan Süre: --</div>
                    <div class="gonderen-bilgi">Oluşturan: ${anket.gonderenAdi || 'Bilinmiyor'}</div>
                </div>
            `;
            
            // En üste ekle
            anketAkisi.insertAdjacentHTML('afterbegin', newCardHTML);
            
            // Yeni kart için zamanlayıcıyı başlat
            sureyiGuncelle(docId, anket);
            if (!timerIntervals[docId]) {
                 timerIntervals[docId] = setInterval(() => sureyiGuncelle(docId, anket), 1000);
            }
        }
        
        // ------------- FIREBASE GERÇEK ZAMANLI DİNLEME -------------
        
        function anketleriDinle() {
            // Sadece aktif anketleri (aktif: true) ve en yeni 50 anketi getir
            db.collection("polls")
              .where("aktif", "==", true)
              .orderBy("sureBasi", "desc")
              .limit(50)
              .onSnapshot(snapshot => {
                
                // Başlangıç mesajını temizle
                if(anketAkisi.querySelector('p')) anketAkisi.innerHTML = ''; 

                snapshot.docChanges().forEach(change => {
                    const docId = change.doc.id;
                    const anketData = change.doc.data();

                    if (change.type === "added" || change.type === "modified") {
                        // Yeni anket eklendiğinde veya veri güncellendiğinde
                        anketKartiOlustur(docId, anketData);
                    } else if (change.type === "removed") {
                        // Firebase'den silinirse kartı kaldır
                        const kartToRemove = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);
                        if (kartToRemove) kartToRemove.remove();
                    }
                });
                
                if (anketAkisi.innerHTML === '') {
                    anketAkisi.innerHTML = '<p style="text-align: center; color: #777;">Şu anda aktif anket bulunmamaktadır.</p>';
                }

            }, error => {
                console.error("Firebase dinleme hatası:", error);
                anketAkisi.innerHTML = '<p style="text-align: center; color: red;">Veri yüklenirken hata oluştu.</p>';
            });
        }
        
        // ------------- OY KULLANMA MANTIĞI (FIREBASE) -------------

        async function oyKullan(anketDocId, secim) {
            if (!currentUserId) {
                alert("Oylama yapmak için önce giriş yapmalısınız.");
                return;
            }

            const anketRef = db.collection("polls").doc(anketDocId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(anketRef);

                    if (!doc.exists) { throw "Anket bulunamadı!"; }
                    
                    const anket = doc.data();
                    
                    // TEK OY KONTROLÜ
                    if (anket.oyKullananlar && anket.oyKullananlar.includes(currentUserId)) {
                        alert("Bu ankete daha önce oy kullandınız. Teşekkürler!");
                        return; // İşlemi bitir
                    }

                    // Oy sayısını artır
                    const yeniOySayisi = (anket.oylar[secim] || 0) + 1;
                    
                    // Oy kullananlar listesine kullanıcı ID'sini ekle
                    const yeniOyKullananlar = [...(anket.oyKullananlar || []), currentUserId];

                    // Veritabanına yeni değerleri yaz
                    transaction.update(anketRef, {
                        [`oylar.${secim}`]: yeniOySayisi,
                        oyKullananlar: yeniOyKullananlar
                    });
                });
                
                // Transaction başarılıysa arayüz otomatik güncellenecektir (onSnapshot sayesinde)
                // Ama kullanıcıya bir mesaj verelim
                alert("Oyunuz başarıyla kaydedildi!");

            } catch (error) {
                console.error("Oy kullanma hatası:", error);
                alert("Oy kullanırken bir hata oluştu: " + error.message);
            }
        }
        
        // ------------- SÜRE SAYACI MANTIĞI -------------
        
        function sureyiGuncelle(docId, anket) {
            // Anketin başlangıç zamanı (Firestore Timestamp) henüz sunucudan gelmediyse bekle
            if (!anket.sureBasi || typeof anket.sureBasi.toDate !== 'function') return;

            const sureBasiMs = anket.sureBasi.toDate().getTime();
            const sureGecen = Math.floor((Date.now() - sureBasiMs) / 1000);
            const kalanSaniye = anket.sureSaniye - sureGecen;

            const sureSayaci = document.getElementById(`sure-sayaci-${docId}`);
            const kart = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);

            if (kalanSaniye <= 0) {
                if(sureSayaci) sureSayaci.innerHTML = "Oylama BİTTİ!";
                
                // Firebase'de aktif alanını false yap (bir daha çekilmesin)
                if(anket.aktif !== false) {
                     db.collection("polls").doc(docId).update({aktif: false}).catch(e => console.error("Aktif durumu güncellenemedi:", e));
                }
                
                // Kartı kaldır (Görsel temizlik)
                if (kart) {
                    kart.style.opacity = '0';
                    setTimeout(() => {
                        kart.remove(); 
                        clearInterval(timerIntervals[docId]);
                        delete timerIntervals[docId];
                    }, 500);
                }
                return;
            }
            
            const dakika = Math.floor(kalanSaniye / 60);
            const saniye = kalanSaniye % 60;
            
            const saniyeStr = saniye < 10 ? '0' + saniye : saniye;
            const dakikaStr = dakika < 10 ? '0' + dakika : dakika;
            
            if(sureSayaci) sureSayaci.innerHTML = `Kalan Süre: ${dakikaStr}:${saniyeStr}`;
        }


        // Sayfa yüklendiğinde anketleri dinlemeye başla
        anketleriDinle(); 
    </script>
</body>
</html>
