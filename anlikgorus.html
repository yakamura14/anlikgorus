<!DOCTYPE html>
<html>
<head>
    <title>AnlıkGörüş - Canlı Akış</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Ana Stiller */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7fa; padding-top: 60px; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background-color: #007bff; color: white; padding: 10px 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header h1 { margin: 0; font-size: 20px; }
        .header button { margin-left: 10px; }
        #cikis-yap { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .anket-olustur-buton { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #anket-akisi { display: flex; flex-direction: column; align-items: center; padding: 15px 0; }
        .anket-karti { 
            width: 95%; max-width: 550px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); margin-bottom: 20px; padding: 15px; overflow: hidden; 
            opacity: 1; 
            transition: opacity 0.5s ease; 
        }
        .oylanmis { opacity: 0.7; border: 2px solid #28a745; }
        .anket-baslik { text-align: center; color: #333; font-size: 18px; margin-bottom: 15px; }
        .secenekler-konteyner { display: flex; gap: 8px; height: 250px; }
        .secenek { flex: 1; position: relative; cursor: pointer; overflow: hidden; border-radius: 8px; transition: transform 0.2s; }
        .resim { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        .oy-gosterge { position: absolute; bottom: 0; left: 0; height: 100%; width: 0%; background: rgba(0, 123, 255, 0.4); z-index: 2; transition: width 0.5s ease-out; }
        .oy-yuzdesi { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold; z-index: 3; }
        .kalan-sure { text-align: center; margin-top: 15px; font-weight: bold; color: #dc3545; font-size: 14px; }
        .gonderen-bilgi { text-align: right; font-size: 12px; color: #777; margin-top: 10px; }
        /* Metin Seçenekleri İçin Stiller */
        .secenek-metin { position: absolute; top: 10px; width: 90%; text-align: center; color: #333; font-weight: bold; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 5px; z-index: 4; }
    </style>
</head>
<body>

    <div class="header">
        <h1>AnlıkGörüş</h1>
        <div>
            <button class="anket-olustur-buton" onclick="window.location.href='anket_olustur.html'">Anket Oluştur</button>
            <button id="cikis-yap">Çıkış Yap</button>
        </div>
    </div>

    <div id="anket-akisi">
        <p style="text-align: center; color: #777;">Anketler Yükleniyor...</p>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // LÜTFEN KENDİ FIREBASE YAPILANDIRMA BİLGİLERİNİZİ EKLEYİN
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <script>
        let currentUserId = null;
        const anketAkisi = document.getElementById('anket-akisi');
        const defaultImageURL = 'https://via.placeholder.com/300x400?text=Resim+Yok'; 
        const timerIntervals = {}; 
        
        // Giriş Kontrolü ve UID Alma
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                // Giriş yapmamışsa, girişe yönlendir
                window.location.href = 'giris.html';
            } else {
                currentUserId = user.uid;
                anketleriDinle(); // Kullanıcı ID'si alındıktan sonra dinlemeyi başlat
            }
        });

        document.getElementById('cikis-yap').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'giris.html';
            }).catch((error) => {
                alert("Çıkış yaparken hata oluştu.");
            });
        });

        // ------------- KART OLUŞTURMA VE GÜNCELLEME -------------
        
        function anketKartiOlustur(docId, anket) {
            if(!currentUserId) return; 

            // Anketin bitiş süresini kontrol et
            if (!anket.sureBasi || typeof anket.sureBasi.toDate !== 'function') return; 
            const sureBasiMs = anket.sureBasi.toDate().getTime();
            const bitisZamaniMs = sureBasiMs + (anket.sureSaniye * 1000);

            // Eğer anketin süresi zaten geçmişse ve aktifse, pasif yap ve gösterme
            if (bitisZamaniMs <= Date.now() && anket.aktif !== false) {
                 // Anketin aktifliğini pasif olarak güncelle (arka planda)
                 db.collection("polls").doc(docId).update({aktif: false});
                 return; // Kartı oluşturma
            }
            
            const oyKullanildi = anket.oyKullananlar && anket.oyKullananlar.includes(currentUserId);
            const oylanmisClass = oyKullanildi ? 'oylanmis' : '';

            const oylarA = anket.oylar.A || 0;
            const oylarB = anket.oylar.B || 0;
            const toplamOy = oylarA + oylarB;
            const yuzdeA = toplamOy > 0 ? Math.round((oylarA / toplamOy) * 100) : 50;
            const yuzdeB = 100 - yuzdeA;
            
            const tiklamaEngeli = oyKullanildi;
            const clickHandler = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'A')"`;
            const clickHandler2 = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'B')"`;
            
            const resimA_var = !!anket.resimA;
            const resimB_
