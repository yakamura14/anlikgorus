<!DOCTYPE html>
<html>
<head>
    <title>AnlıkGörüş - Canlı Akış</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Ana Stiller */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7fa; padding-top: 60px; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background-color: #007bff; color: white; padding: 10px 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header h1 { margin: 0; font-size: 20px; }
        .header button { margin-left: 10px; }
        #cikis-yap { background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .anket-olustur-buton { background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #anket-akisi { display: flex; flex-direction: column; align-items: center; padding: 15px 0; }
        .anket-karti { 
            width: 95%; max-width: 550px; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); margin-bottom: 20px; padding: 15px; overflow: hidden; 
            opacity: 1; 
            transition: opacity 0.5s ease; 
        }
        .oylanmis { opacity: 0.7; border: 2px solid #28a745; }
        .anket-baslik { text-align: center; color: #333; font-size: 18px; margin-bottom: 15px; }
        .secenekler-konteyner { display: flex; gap: 8px; height: 250px; }
        .secenek { flex: 1; position: relative; cursor: pointer; overflow: hidden; border-radius: 8px; transition: transform 0.2s; }
        /* Resim Olmadığında Metnin Daha Net Görünmesi İçin Ayarlar */
        .resim { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        .oy-gosterge { position: absolute; bottom: 0; left: 0; height: 100%; width: 0%; background: rgba(0, 123, 255, 0.4); z-index: 2; transition: width 0.5s ease-out; }
        .oy-yuzdesi { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold; z-index: 3; }
        .kalan-sure { text-align: center; margin-top: 15px; font-weight: bold; color: #dc3545; font-size: 14px; }
        .gonderen-bilgi { text-align: right; font-size: 12px; color: #777; margin-top: 10px; }
        /* Metin Seçenekleri İçin Stiller */
        .secenek-metin { position: absolute; top: 10px; width: 90%; text-align: center; color: #333; font-weight: bold; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 5px; z-index: 4; }
    </style>
</head>
<body>

    <div class="header">
        <h1>AnlıkGörüş</h1>
        <div>
            <button class="anket-olustur-buton" onclick="window.location.href='anket_olustur.html'">Anket Oluştur</button>
            <button id="cikis-yap">Çıkış Yap</button>
        </div>
    </div>

    <div id="anket-akisi">
        <p style="text-align: center; color: #777;">Anketler Yükleniyor...</p>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // LÜTFEN KENDİ FIREBASE YAPILANDIRMA BİLGİLERİNİZİ EKLEYİN
        const firebaseConfig = {
            apiKey: "AIzaSyDqKxitrc3P8LXzHHhZb2utDay7WSvN1-w",
            authDomain: "anket-61fdf.firebaseapp.com",
            projectId: "anket-61fdf",
            storageBucket: "anket-61fdf.firebasestorage.app",
            messagingSenderId: "1009992434674",
            appId: "1:1009992434674:web:17a4b4d0dbf300c42b216b",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <script>
        let currentUserId = null;
        const anketAkisi = document.getElementById('anket-akisi');
        const defaultImageURL = 'https://via.placeholder.com/300x400?text=Resim+Yok'; 
        const timerIntervals = {}; 
        
        // Giriş Kontrolü ve UID Alma
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                alert("Bu sayfayı görüntülemek için lütfen giriş yapın.");
                window.location.href = 'giris.html';
            } else {
                currentUserId = user.uid;
                anketleriDinle(); // Kullanıcı ID'si alındıktan sonra dinlemeyi başlat
            }
        });

        document.getElementById('cikis-yap').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'giris.html';
            }).catch((error) => {
                alert("Çıkış yaparken hata oluştu.");
            });
        });

        // ------------- KART OLUŞTURMA VE GÜNCELLEME -------------
        
        function anketKartiOlustur(docId, anket) {
            if(!currentUserId) return; // Kullanıcı ID'si yoksa kart oluşturma

            const oyKullanildi = anket.oyKullananlar && anket.oyKullananlar.includes(currentUserId);
            const oylanmisClass = oyKullanildi ? 'oylanmis' : '';

            const oylarA = anket.oylar.A || 0;
            const oylarB = anket.oylar.B || 0;
            const toplamOy = oylarA + oylarB;
            const yuzdeA = toplamOy > 0 ? Math.round((oylarA / toplamOy) * 100) : 50;
            const yuzdeB = 100 - yuzdeA;
            
            const tiklamaEngeli = oyKullanildi;
            const clickHandler = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'A')"`;
            const clickHandler2 = tiklamaEngeli ? '' : `onclick="oyKullan('${docId}', 'B')"`;
            
            // Resim/Metin Kontrolleri
            const resimA_var = !!anket.resimA;
            const resimB_var = !!anket.resimB;

            // Kart zaten varsa sadece oy yüzdelerini güncelle
            const existingCard = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);
            if (existingCard) {
                existingCard.querySelector('#yuzde-A-' + docId).innerHTML = `${yuzdeA}%`;
                existingCard.querySelector('#yuzde-B-' + docId).innerHTML = `${yuzdeB}%`;
                existingCard.querySelector('.A-gosterge').style.width = `${yuzdeA}%`;
                existingCard.querySelector('.B-gosterge').style.width = `${yuzdeB}%`;
                if (oyKullanildi && !existingCard.classList.contains('oylanmis')) {
                    existingCard.classList.add('oylanmis');
                    existingCard.querySelectorAll('.secenek').forEach(s => s.removeAttribute('onclick'));
                }
                return;
            }

            // Yeni Kart Oluştur
            const newCardHTML = `
                <div class="anket-karti ${oylanmisClass}" data-anket-id="${docId}">
                    <h2 class="anket-baslik">${anket.baslik}</h2>
                    
                    <div class="secenekler-konteyner">
                        
                        <div class="secenek secenek-sol" ${clickHandler}>
                            <img src="${anket.resimA || defaultImageURL}" alt="Seçenek A" class="resim" style="opacity: ${resimA_var ? 1 : 0.2};">
                            <div class="oy-gosterge A-gosterge" style="width: ${yuzdeA}%;"></div>
                            <span class="oy-yuzdesi" id="yuzde-A-${docId}" style="color: ${resimA_var ? 'white' : '#333'}; text-shadow: ${resimA_var ? '0 0 4px rgba(0, 0, 0, 0.6)' : 'none'};">${yuzdeA}%</span>
                            <span class="secenek-metin" style="display: ${anket.metinA ? 'block' : 'none'};">${anket.metinA || ''}</span>
                        </div>

                        <div class="secenek secenek-sag" ${clickHandler2}>
                            <img src="${anket.resimB || defaultImageURL}" alt="Seçenek B" class="resim" style="opacity: ${resimB_var ? 1 : 0.2};">
                            <div class="oy-gosterge B-gosterge" style="width: ${yuzdeB}%;"></div>
                            <span class="oy-yuzdesi" id="yuzde-B-${docId}" style="color: ${resimB_var ? 'white' : '#333'}; text-shadow: ${resimB_var ? '0 0 4px rgba(0, 0, 0, 0.6)' : 'none'};">${yuzdeB}%</span>
                            <span class="secenek-metin" style="display: ${anket.metinB ? 'block' : 'none'};">${anket.metinB || ''}</span>
                        </div>
                    </div>
                    
                    <div class="kalan-sure" id="sure-sayaci-${docId}">Kalan Süre: --</div>
                    <div class="gonderen-bilgi">Oluşturan: ${anket.gonderenAdi || 'Bilinmiyor'}</div>
                </div>
            `;
            
            // En üste ekle
            anketAkisi.insertAdjacentHTML('afterbegin', newCardHTML);
            
            // Yeni kart için zamanlayıcıyı başlat
            sureyiGuncelle(docId, anket);
            if (!timerIntervals[docId]) {
                 timerIntervals[docId] = setInterval(() => sureyiGuncelle(docId, anket), 1000);
            }
        }
        
        // ------------- FIREBASE GERÇEK ZAMANLI DİNLEME -------------
        
        function anketleriDinle() {
            // Sadece aktif anketleri (aktif: true) ve en yeni 50 anketi getir
            db.collection("polls")
              .where("aktif", "==", true)
              .orderBy("sureBasi", "desc")
              .limit(50)
              .onSnapshot(snapshot => {
                
                if(anketAkisi.querySelector('p')) anketAkisi.innerHTML = ''; 

                snapshot.docChanges().forEach(change => {
                    const docId = change.doc.id;
                    const anketData = change.doc.data();

                    if (change.type === "added" || change.type === "modified") {
                        // Eğer anket artık aktif değilse, kartı kaldırma işlemi aşağıda halledilecek
                        anketKartiOlustur(docId, anketData);
                    } else if (change.type === "removed") {
                        const kartToRemove = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);
                        if (kartToRemove) kartToRemove.remove();
                    }
                });
                
                if (anketAkisi.innerHTML === '') {
                    anketAkisi.innerHTML = '<p style="text-align: center; color: #777;">Şu anda aktif anket bulunmamaktadır.</p>';
                }

            }, error => {
                console.error("Firebase dinleme hatası:", error);
                // Hata durumunda ekrana tekrar "Anketler Yükleniyor" yerine hata mesajı yazdır
                anketAkisi.innerHTML = '<p style="text-align: center; color: red;">Veri yüklenirken hata oluştu. (Konsolu kontrol edin)</p>';
            });
        }
        
        // ------------- OY KULLANMA MANTIĞI (FIREBASE) -------------

        async function oyKullan(anketDocId, secim) {
            if (!currentUserId) {
                alert("Oylama yapmak için önce giriş yapmalısınız.");
                return;
            }

            const anketRef = db.collection("polls").doc(anketDocId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(anketRef);

                    if (!doc.exists) { throw new Error("Anket bulunamadı!"); }
                    
                    const anket = doc.data();
                    
                    // 1. Süre kontrolü
                    const sureBasiMs = anket.sureBasi.toDate().getTime();
                    const sureGecen = Math.floor((Date.now() - sureBasiMs) / 1000);
                    const kalanSaniye = anket.sureSaniye - sureGecen;
                    if (kalanSaniye <= 0) {
                        // Eğer süre bittiyse anketi pasif yap
                        transaction.update(anketRef, { aktif: false });
                        throw new Error("Oylama süresi sona ermiştir!"); 
                    }

                    // 2. Oy kullanıldı kontrolü
                    if (anket.oyKullananlar && anket.oyKullananlar.includes(currentUserId)) {
                        alert("Bu ankete daha önce oy kullandınız. Teşekkürler!");
                        return; // Transaction'dan çık
                    }

                    const yeniOySayisi = (anket.oylar[secim] || 0) + 1;
                    const yeniOyKullananlar = [...(anket.oyKullananlar || []), currentUserId];

                    transaction.update(anketRef, {
                        [`oylar.${secim}`]: yeniOySayisi,
                        oyKullananlar: yeniOyKullananlar
                    });
                });
                
                alert("Oyunuz başarıyla kaydedildi!");

            } catch (error) {
                console.error("Oy kullanma hatası:", error);
                alert("Oy kullanırken bir hata oluştu: " + error.message);
            }
        }
        
        // ------------- SÜRE SAYACI MANTIĞI -------------
        
        function sureyiGuncelle(docId, anket) {
            // sureBasi henüz gelmemişse veya fonksiyon değilse (Base64 data vs.) çık
            if (!anket.sureBasi || typeof anket.sureBasi.toDate !== 'function') return; 

            const sureBasiMs = anket.sureBasi.toDate().getTime();
            const sureGecen = Math.floor((Date.now() - sureBasiMs) / 1000);
            const kalanSaniye = anket.sureSaniye - sureGecen;

            const sureSayaci = document.getElementById(`sure-sayaci-${docId}`);
            const kart = document.querySelector(`.anket-karti[data-anket-id="${docId}"]`);

            if (kalanSaniye <= 0) {
                if(sureSayaci) sureSayaci.innerHTML = "Oylama BİTTİ!";
                
                if(anket.aktif !== false) {
                     // Süre dolduğunda aktif durumunu pasif yap
                     db.collection("polls").doc(docId).update({aktif: false}).catch(e => console.error("Aktif durumu güncellenemedi:", e));
                }
                
                if (kart) {
                    // Kartı yavaşça kaldır
                    kart.style.opacity = '0';
                    setTimeout(() => {
                        kart.remove(); 
                        clearInterval(timerIntervals[docId]);
                        delete timerIntervals[docId];
                    }, 500);
                }
                return;
            }
            
            const dakika = Math.floor(kalanSaniye / 60);
            const saniye = kalanSaniye % 60;
            
            const saniyeStr = saniye < 10 ? '0' + saniye : saniye;
            const dakikaStr = dakika < 10 ? '0' + dakika : dakika;
            
            if(sureSayaci) sureSayaci.innerHTML = `Kalan Süre: ${dakikaStr}:${saniyeStr}`;
        }
    </script>
</body>
</html>
